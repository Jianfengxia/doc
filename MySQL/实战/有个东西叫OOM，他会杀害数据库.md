# 什么是OOM？ #
OOM，全称“Out Of Memory”，翻译成中文就是“内存用完了”。
Linux下有一种OOM KILLER 的机制，它会在系统内存耗尽的情况下，启用自己算法有选择性的kill 掉一些进程，保证系统稳定。
　　1. 为什么会有OOM killer
　　当我们使用应用时，需要申请内存，即进行malloc的操作，进行malloc操作如果返回一个非NULL的操作表示申请到了可用的内存。事实上，这个地方是可能存在bug的。Linux有一种内存优化机制，即：允许程序申请比系统可用内存更多的内存，但是Linux并不保证这些内存马上可用，如果凑巧你申请到的内存中在你需要使用的时候还没有完全释放出来，这个时候就会触发OOM killer了。内核代码为：mm/oom_kill.c，其调用顺序为：
　　malloc -> _alloc_pages -> out_of_memory() -> select_bad_process() -> badness()
　　2. 如何选择要kill掉的进程
　　分析badness代码，其选择过程如下：
　　1）计算该进程以及其子进程所占用的内存；
　　2）计算CPU时间和存活时间
　　3）做相应的权重调整
　　总结起来，就是占用内存越高，得分越高，cpu时间和存活时间越高，得分越低；进程优先级越高，得分越低
　　综合上述因素后，会得到一个point的值，得分最高的会被选中，然后被kill掉。

# MySQL为何会发生OOM KILL？ #
1.如果数据库配置设置不合理
2.数据库服务器压力太大
3.数据库服务器其他占用内存的应用也申请了大量资源。

由于数据库占用了大量的服务器内存资源，几乎触发OOM KILLER，会第一时间优先KILL掉数据库进程，造成线上服务不可用的情况，非常危险。

# 如何防止？ #
个人认为:
1.监控为主，尽早发现数据库是否存在压力，适当调整数据库参数配置，或者扩展数据库硬件配置。

2. echo -17> /proc/${MySQL_PID}/oom_adj  #禁用OOM
设置MySQL在linux服务器触发OOM KILL时，不KILL它，只KILL其他，哈哈
注释:
以linux-3.3.6版本的kernel源码为例，路径为linux-3.6.6/include/linux/oom.h，阅读内核源码可知oom_adj的可调值为15到-16，其中15最大-16最小，-17为禁止使用OOM。oom_score为2的n次方计算出来的，其中n就是进程的oom_adj值，所以oom_score的分数越高就越会被内核优先杀掉。
